---
title: "ch VDJdb distances between ends of loops"
output:
  html_document: default
  pdf_document:
    keep_tex: yes
    latex_engine: xelatex
header-includes:
- \usepackage{amsmath,amsthm,amssymb}
- \usepackage{mathtext}
- \usepackage[T1,T2A]{fontenc}
- \usepackage[utf8]{inputenc}
- \usepackage[english,russian]{babel}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Open file with B_CDR3 distances and create plots:
```{r}
library(reshape2)
library(ggplot2)
library(gplots)
library(plyr)
library(MASS)
library(stringr)
library(dplyr)
```

```{r}
is_outlier <- function(x) {
  return(x > quantile(x, 0.75) + 1.5*IQR(x))
}

give.n <- function(x){
  return(c(y = 0.3, label = length(x)))
}

df = read.table("seqdata/HomoSapiens/distances/cdr_and_antigen.txt", header = T, sep = "\t") %>% select(CDR_chain, poscdr, ascordesc, distance, pdb, cdr_seq)
df$distance <- 1/df$distance

df$poscdrasc <- paste(df$poscdr, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$cdr_seq))

df$outlier <- ifelse((ave(df$distance, df$poscdrasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = poscdr, group = poscdr, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```
```{r}
df = read.table("seqdata/HomoSapiens/distances/min_cdr_and_antigen.txt", header = T, sep = "\t") %>% select(CDR_chain, poscdr, ascordesc, distance, cdr_len)
df$cdr_len_center = df$cdr_len/2
ggplot(df, aes(x = cdr_len, group = cdr_len, y = poscdr)) +
                  geom_boxplot() +
                  facet_grid(~ascordesc, scales="free")

```

```{r}
library(dplyr)
df = read.table("seqdata/HomoSapiens/distances/cdr_and_antigen_1.txt", header = T, sep = "\t") %>% select(CDR_chain, poscdr, ascordesc, distance, pdb, cdr_seq)
df$distance <- 1/df$distance

df$poscdrasc <- paste(df$poscdr, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$cdr_seq))

df$outlier <- ifelse((ave(df$distance, df$poscdrasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = poscdr, group = poscdr, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```

```{r}
df = read.table("seqdata/HomoSapiens/distances/min_cdr_and_antigen_1.txt", header = T, sep = "\t") %>% select(CDR_chain, poscdr, ascordesc, distance, cdr_len)
df$cdr_len_center = df$cdr_len/2
ggplot(df, aes(x = cdr_len, group = cdr_len, y = poscdr)) +
                  geom_boxplot() +
                  facet_grid(CDR_chain~ascordesc, scales="free")

```

```{r}
df = read.table("seqdata/HomoSapiens/distances/antigen_and_cdr.txt", header = T, sep = "\t") %>% select(CDR_chain, posant, ascordesc, distance, pdb, ant_seq)
df$distance <- 1/df$distance

df$posantasc <- paste(df$posant, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$ant_seq))

df$outlier <- ifelse((ave(df$distance, df$posantasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = posant, group = posant, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```

```{r}
df = read.table("seqdata/HomoSapiens/distances/min_antigen_and_cdr.txt", header = T, sep = "\t") %>% select(CDR_chain, posant, ascordesc, distance, ant_len)
df$cdr_len_center = df$ant_len/2
ggplot(df, aes(x = ant_len, group = ant_len, y = posant)) +
                  geom_boxplot() +
                  facet_grid(CDR_chain~ascordesc, scales="free")

```

```{r}
df = read.table("seqdata/HomoSapiens/distances/antigen_and_cdr_1.txt", header = T, sep = "\t") %>% select(CDR_chain, posant, ascordesc, distance, pdb, ant_seq)
df$distance <- 1/df$distance

df$posantasc <- paste(df$posant, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$ant_seq))

df$outlier <- ifelse((ave(df$distance, df$posantasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = posant, group = posant, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```

```{r}
df = read.table("seqdata/HomoSapiens/distances/min_antigen_and_cdr_1.txt", header = T, sep = "\t") %>% select(CDR_chain, posant, ascordesc, distance, ant_len)
df$cdr_len_center = df$ant_len/2
ggplot(df, aes(x = ant_len, group = ant_len, y = posant)) +
                  geom_boxplot() +
                  facet_grid(CDR_chain~ascordesc, scales="free")

```

```{r}
df = read.table("seqdata/HomoSapiens/distances/cdr_and_antigen.txt", header = T, sep = "\t") %>% select(CDR_chain, poscdr, ascordesc, distance, pdb, cdr_seq, mhc_type)
df$distance <- 1/df$distance

df$poscdrasc <- paste(df$poscdr, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$cdr_seq))

df$outlier <- ifelse((ave(df$distance, df$poscdrasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = poscdr, group = poscdr, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc~mhc_type, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```
```

```{r}
df = read.table("seqdata/HomoSapiens/distances/antigen_and_cdr.txt", header = T, sep = "\t") %>% select(CDR_chain, posant, ascordesc, distance, pdb, ant_seq, mhc_type)
df$distance <- 1/df$distance

df$posantasc <- paste(df$posant, df$CDR_chain, df$ascordesc, sep='')

df$length <- nchar(as.character(df$ant_seq))

df$outlier <- ifelse((ave(df$distance, df$posantasc, FUN=(is_outlier)))==1, ifelse(df$distance > 0.2, as.character(paste(df$pdb, as.character(df$length), as.character(df$CDR_chain), sep='_')), as.numeric(NA)), as.numeric(NA))

print(unique(df$outlier))
ggplot(df, aes(x = posant, group = posant, y = distance)) +
                  geom_boxplot() +
                  geom_text(aes(label=outlier), size=1.5, na.rm=TRUE) +
                  facet_grid(CDR_chain~ascordesc~mhc_type, scales="free") + 
                  stat_summary(fun.data = give.n, geom = "text", fun.y=max, size=2)
```